{% extends "contributor/service/index/index.html" %}
{% load static %}

{% block content %}
    <div class = "report-body">
        <div class = "report-section">
            <h1>CREATE REPORT</h1>
        </div>

        <form action = "" class = "report-form" method = "POST" enctype = "multipart/form-data">
            {% csrf_token %}

            <div id = "first-tab" class = "tab-content">        
                <div class = "controls-wrapper">
                    <div class = "control-section">
                        <i class = "fa-solid fa-camera"></i>

                        <label for = "post-photo-capture" class = "capture-photo">
                            Capture with camera
                        </label>

                        <input type = "file" class = "invisible-input-capture post-photo-capture" id = "post-photo-capture" name = "post_photos_capture" accept = "image/*" capture = "environment" multiple required>
                    </div>
            
                    <div class = "control-section">
                        <i class = "fa-solid fa-image"></i>

                        <label for = "post-photo-choose" class = "browse-photo">
                            Choose an image
                        </label>

                        <input type = "file" class = "invisible-input-choose post-photo-choose" id = "post-photo-choose" name = "post_photos_choose" accept = "image/*" multiple required>
                    </div>
                </div>
                
                <div class = "report-gallery"></div>
            
                <div class = "capture-date">
                    <label for = "capture-date">Capture Date</label>

                    <input type = "datetime-local" id = "capture-date" name = "capture_date" required>
                </div>            

                <h1>MAP</h1>

                <div class = "map">
                    <div class=  "report-map">
                    </div>
                </div>

                <div class = "coordinates">
                    <div class = "coordinates">
                        <input type = "hidden" id = "latitude" name = "latitude" required>
                    </div>

                    <div class = "coordinates">
                        <input type = "hidden" id = "longitude" name = "longitude" required>
                    </div>
                </div>

                <div class = "location">
                    <label for = "location">Location</label>

                    <input type = "text" class = "location" id = "location" name = "location" required>
                </div>

                <div class = "address">
                    <label for = "address">Address</label>
                    
                    <select name = "address" id = "address" required>
                        <option disabled selected value>Select Address</option>

                        {% for address in addresses %}
                            <option value = "{{address.id}}">{{address}}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class = "buttons">
                    <div class = "save-report">
                        <a>Save as draft</a>
                    </div>

                    <button type = "button" class = "next-report" onclick = "nextTab('first-tab')">Next</button>
                </div>
            </div>

            <div id = "second-tab" class = "tab-content" style = "display: none;">
                <div class = "description">

                    <label for = "description">Description</label>

                    <textarea type = "text" id = "description" name = "description" required></textarea>
                </div>

                <h1>OPTIONALS</h1>

                <div class = "size">
                    <label for = "size">Size</label>
                    
                    <input placeholder = "Size of COTS (ex. 12-15 cm)" type = "number" value = "" id = "size" name = "size">
                </div>

                    
                <div class = "density">
                    <label for = "density">Density</label>
                    
                    <input placeholder = "Estimated Number of COTS (ex. 15)" type = "number" value = "" id = "density" name = "density">
                </div>

                <div class = "depth">
                    <label for = "depth">DEPTH</label>
                    
                    <select name = "depth" id = "depth">
                        <option disabled selected value>Select Depth</option>

                        {% for depth in depths %}
                            <option value="{{depth.id}}">{{depth}}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class = "weather">
                    <label for = "weather">WEATHER</label>
                    
                    <select name = "weather" id = "weather">
                        <option disabled selected value>Select Weather</option>

                        {% for weather in weathers %}
                            <option style = "width: 100vw;" value = "{{weather.id}}">{{weather}}</option>
                        {% endfor %}
                    </select>
                </div>

                <input type = "hidden" name = "action" id = "action">

                <div class = "buttons">
                    <button type = "button" class = "back-report" onclick = "openTab('first-tab')">Back to previous</button>

                    <div class = "save-report">
                        <a data-action = "save as draft">Save as draft</a>
                    </div>

                    <div class = "save-report">
                        <a data-action = "save and submit">Save and submit</a>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <script>
        function openTab(tabName){
            var i, tabcontent, tablinks;

            tabcontent = document.getElementsByClassName("tab-content");

            for (i = 0; i < tabcontent.length; i++){
                tabcontent[i].style.display = "none";
            }

            tablinks = document.getElementsByClassName("tab-link");

            for (i = 0; i < tablinks.length; i++){
                tablinks[i].classList.remove("active");
            }

            document.getElementById(tabName).style.display = "block";

            event.currentTarget.classList.add("active");
        }

        function nextTab(currentTabId){
            var currentTab = document.getElementById(currentTabId);

            var nextTab = currentTab.nextElementSibling;

            openTab(nextTab.id);
        }

        openTab("first-tab");
    </script>

    <script>
        document.querySelector(".browse-photo").addEventListener("click", function(event){
            event.preventDefault()

            document.querySelector(".post-photo-choose").click();

            document.querySelector(".post-photo-capture").removeAttribute("required");
        });

        document.querySelector(".capture-photo").addEventListener("click", function(event){
            event.preventDefault()
            
            document.querySelector(".post-photo-capture").click();

            document.querySelector(".post-photo-choose").removeAttribute("required");
        });
    </script>

    <script>
        const browsePhoto = document.querySelector(".post-photo-choose");

        const capturePhoto = document.querySelector(".post-photo-capture");

        const reportGallery = document.querySelector(".report-gallery");

        let photoWrapper = null;

        function updateGalleryVisibility(){
            if (photoWrapper && photoWrapper.children.length === 0){
                reportGallery.style.display = "none";

                reportGallery.style.paddingTop = "0px";

                reportGallery.style.paddingBottom = "0px";


            } else{
                reportGallery.style.display = "block";

                reportGallery.style.paddingTop = "10px";

                reportGallery.style.paddingBottom = "10px";
            };
        };

        function updateLastPhotoContainerMargin(){
            const photoContainers = photoWrapper.querySelectorAll("div");

            photoContainers.forEach(container => {
                container.style.marginRight = "10px";
            });

            if (photoContainers.length > 0){
                photoContainers[photoContainers.length - 1].style.marginRight = "0px";
            };

            updateGalleryVisibility();
        }

        function addImageToGallery(file){
            const reader = new FileReader();

            reader.onload = function(event){
                if (!photoWrapper){
                    photoWrapper = document.createElement("div");

                    photoWrapper.classList.add("gallery-photo");

                    photoWrapper.style.position = "relative";
                    
                    photoWrapper.style.paddingLeft = "10px";

                    photoWrapper.style.paddingRight = "10px";

                    photoWrapper.style.paddingTop = "10px";

                    photoWrapper.style.paddingBottom = "10px";

                    photoWrapper.style.height = "250px";

                    photoWrapper.style.borderRadius = "5px";

                    photoWrapper.style.backgroundColor = "#FFFFFF";

                    photoWrapper.style.overflowX = "auto";

                    photoWrapper.style.overflowY = "hidden";

                    photoWrapper.style.whiteSpace = "nowrap";

                    reportGallery.appendChild(photoWrapper);
                };

                const photoContainer = document.createElement("div");
            
                photoContainer.style.position = "relative";
            
                photoContainer.style.display = "inline-block";

                photoContainer.style.marginRight = "10px";
            
                photoContainer.style.width = "100%"; 
            
                photoContainer.style.height = "100%";
            
                const photoElement = document.createElement("img");
                
                photoElement.src = event.target.result;
                
                photoElement.style.placeItems = "center";

                photoElement.style.objectFit = "cover";

                photoElement.style.width = "100%";
                
                photoElement.style.height = "100%";

                photoElement.style.borderRadius = "5px";

                photoElement.style.overflow = "hidden";

                const deleteButton = document.createElement("i");                
                
                deleteButton.classList.add("fas", "fa-trash");

                deleteButton.style.position = "absolute";

                deleteButton.style.top = "10px";

                deleteButton.style.right = "10px";

                deleteButton.style.paddingLeft = "10px";

                deleteButton.style.paddingRight = "10px";

                deleteButton.style.paddingTop = "10px";

                deleteButton.style.paddingBottom = "10px";

                deleteButton.style.fontSize = "20px";

                deleteButton.style.color = "#FFFFFF";

                deleteButton.style.cursor = "pointer";
                
                deleteButton.onclick = function(){
                    photoWrapper.removeChild(photoElement.parentNode);

                    updateLastPhotoContainerMargin();
                };
                
                photoWrapper.appendChild(photoElement);

                photoWrapper.appendChild(deleteButton);       
                
                photoContainer.appendChild(photoElement);
            
                photoContainer.appendChild(deleteButton);
            
                photoWrapper.appendChild(photoContainer);

                updateLastPhotoContainerMargin();
            };

            reader.readAsDataURL(file);
        };

        function handleFiles(files){
            photoWrapper = null

            reportGallery.innerHTML = "";

            Array.from(files).forEach(file => addImageToGallery(file));
        }

        browsePhoto.addEventListener("change", (event) => {
            handleFiles(event.target.files);
        });

        capturePhoto.addEventListener("change", (event) => {
            handleFiles(event.target.files);
        });
    </script>

    <script>
        document.querySelector(".post-photo-choose").addEventListener("change", function(){
            for (var i = 0; i < this.files.length; i++){
                var reportFile = this.files[i];

                var modifiedDate = reportFile.lastModifiedDate;

                var formattedDate = modifiedDate.toISOString().slice(0, 16);

                document.getElementById("capture-date").value = formattedDate;
            }
        });

        document.querySelector(".post-photo-capture").addEventListener("change", function(){
            for (var i = 0; i < this.files.length; i++){
                var reportFile = this.files[i];

                var modifiedDate = reportFile.lastModifiedDate;

                var formattedDate = modifiedDate.toISOString().slice(0, 16);

                document.getElementById("capture-date").value = formattedDate;
            }
        });
    </script>

    <script>
        var map;

        var report;

        function revealMap(){
            var starfish = L.icon({iconUrl: "{% static 'assets/pin.png' %}", iconSize: [30, 30], iconAnchor: [15, 15]});

            report = L.marker([5.9656, 125.1929], {draggable: true, icon: starfish});

            var reportMap = document.getElementsByClassName("report-map")[0];
            
            var background = L.tileLayer("http://{s}.google.com/vt?lyrs=m&x={x}&y={y}&z={z}", {minZoom: 11, maxZoom: 15, subdomains:["mt0","mt1","mt2","mt3"], attribution: "Google"});

            map = L.map(reportMap, {zoomControl: true, scrollWheelZoom: false, dragging: true, maxBounds: [[5.3, 124.3],[6.3, 126.3]], layers: [background, report]}).setView([5.9656, 125.1929], 11);

            map.attributionControl.setPosition("bottomleft");
                
            report.on("drag", function(event){
                var position = event.target.getLatLng();
                
                updateCoordinates(position.lat, position.lng);                
            });

            report.on("dragend", function(event){
                var position = event.target.getLatLng();
                
                updateCoordinates(position.lat, position.lng);

                updateAddress(position.lat, position.lng);
            });

            var defaultLatitude = report.getLatLng().lat;

            var defaultLongitude = report.getLatLng().lng;

            updateCoordinates(defaultLatitude, defaultLongitude);

            updateAddress(defaultLatitude, defaultLongitude);
        };

        function updateAddress(){
            var position = report.getLatLng();

            fetch("https://nominatim.openstreetmap.org/reverse?lat=" + position.lat + "&lon=" + position.lng + "&format=json").then(response => {return response.json();}).then(data => {var address = getAddressComponents(data); document.getElementById("location").value = address;});
        };

        function getAddressComponents(data){
            var addressComponents = [];

            if (data.address){
                if (data.address.house_name) addressComponents.push(data.address.house_name);

                if (data.address.house_number) addressComponents.push(data.address.house_number);

                if (data.address.road) addressComponents.push(data.address.road);

                if (data.address.retail) addressComponents.push(data.address.retail);

                if (data.address.commercial) addressComponents.push(data.address.commercial);

                if (data.address.industrial) addressComponents.push(data.address.industrial);

                if (data.address.farmyard) addressComponents.push(data.address.farmyard);

                if (data.address.farm) addressComponents.push(data.address.farm);

                if (data.address.residential) addressComponents.push(data.address.residential);

                if (data.address.city_block) addressComponents.push(data.address.city_block);

                if (data.address.quarter) addressComponents.push(data.address.quarter);

                if (data.address.allotments) addressComponents.push(data.address.allotments);

                if (data.address.neighbourhood) addressComponents.push(data.address.neighbourhood);

                if (data.address.isolated_dwelling) addressComponents.push(data.address.isolated_dwelling);

                if (data.address.croft) addressComponents.push(data.address.croft);

                if (data.address.hamlet) addressComponents.push(data.address.hamlet);

                if (data.address.suburb) addressComponents.push(data.address.suburb);

                if (data.address.borough) addressComponents.push(data.address.borough);

                if (data.address.district) addressComponents.push(data.address.district);

                if (data.address.city_district) addressComponents.push(data.address.city_district);

                if (data.address.municipality) addressComponents.push(data.address.municipality);

                if (data.address.village) addressComponents.push(data.address.village);

                if (data.address.town) addressComponents.push(data.address.town);

                if (data.address.city) addressComponents.push(data.address.city);
            };

            return addressComponents.join(", ");
        };

        function updateCoordinates(latitude, longitude){
            var latitudeInput = document.getElementById("latitude");

            var longitudeInput = document.getElementById("longitude");

            latitudeInput.value = latitude.toFixed(6);
            
            longitudeInput.value = longitude.toFixed(6);
        };

        window.addEventListener("load", function (){
            revealMap();
        });
    </script>

    <script>
        function refreshMap(){
            map.setView([5.9656, 125.1929], 11);
        };

        document.querySelector(".refresh-map").addEventListener("click", refreshMap);
    </script>

    <script>
        function fetchLocation(){
            if (navigator.geolocation){
                navigator.geolocation.getCurrentPosition(checkPosition);
                
            } else{
                Swal.fire({title: "Oops!", text: "The location is not supported and cannot be given to COTSEye.", background: "#FFFFFF", icon: "error", iconColor: "#C90016", allowOutsideClick: false, allowEscapeKey: false, confirmButtonColor: "#C90016", customClass: {confirmButton: "error-button", title: "title"}});                
            };
        };

        function checkPosition(position){
            const maximumLatitude = 6.3;

            const minimumLatitude = 5.3;
            
            const maximumLongitude = 126.3;
            
            const minimumLongitude = 124.3;
            
            const latitude = position.coords.latitude;
            
            const longitude = position.coords.longitude;

            if (latitude < minimumLatitude || latitude > maximumLatitude || longitude < minimumLongitude || longitude > maximumLongitude){
                
                document.querySelector(".post-photo-capture").addEventListener("click", function(){
                    event.preventDefault();
                    
                    Swal.fire({title: "Oops!", text: "The location given to COTSEye incorporated coordinates out of bounds.", background: "#FFFFFF", icon: "error", iconColor: "#C90016", allowOutsideClick: false, allowEscapeKey: false, confirmButtonColor: "#C90016", customClass: {confirmButton: "error-button", title: "title"}});
                });

            } else{
                updateCoordinates(latitude, longitude);

                report.setLatLng([latitude, longitude]);

                map.setView([latitude, longitude], 11);

                document.querySelector(".capture-photo").addEventListener("click", function(){
                    document.querySelector(".post-photo-capture").click();
                });

            };
        };

        document.addEventListener("DOMContentLoaded", function (){
            revealMap();

            const captureButton = document.querySelector(".post-photo-capture");

            if (captureButton){
                captureButton.addEventListener("click", function (event){
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
                        Swal.fire({title: "Oops!", text: "The camera is not supported and cannot be given to COTSEye.", background: "#FFFFFF", icon: "error", iconColor: "#C90016", allowOutsideClick: false, allowEscapeKey: false, confirmButtonColor: "#C90016", customClass: {confirmButton: "error-button", title: "title"}});
                    };
                });
            }
        });
    </script>

    <script>
        let reportPhoto;

        document.querySelector(".post-photo-choose").addEventListener("change", function(e){
            const reportFile = e.target.files[0];

            const photo = new Image();

            photo.src = URL.createObjectURL(reportFile);

            photo.onload = function(){
                EXIF.getData(photo, function(){
                    const latitude = EXIF.getTag(this, "GPSLatitude");

                    const longitude = EXIF.getTag(this, "GPSLongitude");

                    if (latitude && longitude){
                        const roundLatitude = parseFloat(latitude).toFixed(6);

                        const roundLongitude = parseFloat(longitude).toFixed(6);
                        
                        if (checkCoordinates(roundLatitude, roundLongitude)){
                            document.getElementById("latitude").value = roundLatitude;

                            document.getElementById("longitude").value = roundLongitude;
                            
                            reportPhoto = photo;

                        } else{
                            Swal.fire({title: "Oops!", text: "The photo given to COTSEye incorporated coordinates out of bounds.", background: "#FFFFFF", icon: "error", iconColor: "#C90016", allowOutsideClick: false, allowEscapeKey: false, confirmButtonColor: "#C90016", customClass: {confirmButton: "error-button", title: "title"}});
                            
                            resetCaptureDate();

                            document.querySelector(".gallery-photo").src = "{% static 'assets/posts/default.png' %}";
                        };

                    } else{
                        Swal.fire({title: "Hey!", text: "The photo given to COTSEye did not incorporate any coordinates.", background: "#FFFFFF", icon: "warning", iconColor: "#154360", allowOutsideClick: false, allowEscapeKey: false, confirmButtonColor: "#154360", customClass: {confirmButton: "info-button", title: "title"}});
                    };
                });
            };
        });

        function checkCoordinates(latitude, longitude){
            const maximumLatitude = 6.3;

            const minimumLatitude = 5.3;
            
            const maximumLongitude = 126.3;
            
            const minimumLongitude = 124.3;

            return(
                latitude >= minimumLatitude &&
            
                latitude <= maximumLatitude &&
            
                longitude >= minimumLongitude &&
            
                longitude <= maximumLongitude
            );
        };

        function resetCaptureDate(){
            document.getElementById("capture-date").value = "";
        };
    </script>

    <script>
        document.querySelectorAll(".save-report").forEach(item => {
            item.addEventListener("click", function(event){
                event.preventDefault();

                if (!navigator.onLine){
                    const username = "{{request.user.username}}";

                    Swal.fire({title: "Hey!", text: username + ", your information input was recorded offline for COTSEye. Kindly visit the current page again if back online.", background: "#FFFFFF", icon: "warning", iconColor: "#154360", allowOutsideClick: false, allowEscapeKey: false, confirmButtonColor: "#154360", customClass: {confirmButton: "info-button", title: "title"}}).then(() => {location.reload();});

                } else{
                    const action = this.getAttribute("data-action");

                    document.getElementById("action").value = action;
                    
                    document.querySelector(".report-form").submit();
                };
            });
        });
    </script>

    <script>
        const indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB || window.shimIndexedDB;
        
        const request = indexedDB.open("cotseye", 1);

        request.onupgradeneeded = (event) => {
            const cotseye = event.target.result;
        
            const cotseye_schema = cotseye.createObjectStore("cotseye_schema", {autoIncrement: true});
        };

        request.onsuccess = (event) => {
            const cotseye = event.target.result;

            const form = document.querySelector(".report-form");

            {% if draft_post %}
                const id = "{{draft_post.id}}";
            {% endif %}

            const user = "{{request.user.id}}";

            if(!navigator.onLine){
                document.querySelector(".post-photo-choose").addEventListener("change", () => {
                    const files = document.querySelector(".post-photo-choose").files;

                    for (let i = 0; i < files.length; i++){
                        const reader = new FileReader();
                        
                        reader.addEventListener("load", (event) => {
                            postPhotos.push(event.target.result);
                        });
                        
                        reader.readAsDataURL(files[i]);
                    };
                });

                const postPhotos = [];

                document.querySelector(".save-report").addEventListener("click", (event) => {
                    event.preventDefault();

                    const information = new FormData(form);

                    const captureDate = information.get("capture_date");

                    const description = information.get("description");

                    const latitude = information.get("latitude");

                    const longitude = information.get("longitude");

                    const size = information.get("size");

                    const depth = information.get("depth");

                    const density = information.get("density");

                    const weather = information.get("weather");

                    const transaction = cotseye.transaction("cotseye_schema", "readwrite");

                    const cotseye_schema = transaction.objectStore("cotseye_schema");

                    const post = {            
                        {% if draft_post %}
                            id: parseInt(id),
                        {% endif %}        

                        user: parseInt(user),

                        capture_date: new Date(captureDate),
                        
                        description: description,

                        post_photos: postPhotos,

                        latitude: parseFloat(latitude),

                        longitude: parseFloat(longitude),

                        size: parseInt(size),

                        depth: parseInt(depth),

                        density: parseInt(density),

                        weather: parseInt(weather)
                    };

                    cotseye_schema.add(post);
                }); 
            };

            if(navigator.onLine){
                const transaction = cotseye.transaction("cotseye_schema", "readonly");

                const cotseye_schema = transaction.objectStore("cotseye_schema");

                const post = cotseye_schema.getAll();

                post.onsuccess = (event) => {
                    const information = event.target.result;

                    if(information && information.length > 0){
                        const json = JSON.stringify(information);

                        const token = "{{csrf_token}}"

                        {% if draft_post %}
                            fetch("{% url 'Contributor Service Report Update Fetch' %}", {
                                method: "POST",

                                headers: {"Content-Type": "application/json", "X-CSRFToken": token},

                                body: json

                            }).then(() => {
                                const request = indexedDB.open("cotseye", 1);

                                request.onsuccess = (event) => {
                                    const cotseye = event.target.result;
                                    
                                    const transaction = cotseye.transaction("cotseye_schema", "readwrite");
                                    
                                    const cotseye_schema = transaction.objectStore("cotseye_schema");
                                    
                                    cotseye_schema.clear();

                                    const username = "{{request.user.username}}";

                                    Swal.fire({title: "Yay!", text: username + ", " + "your information input recorded offline was delivered to COTSEye.", background: "#FFFFFF", icon: "success", iconColor: "#698F3F", allowOutsideClick: false, allowEscapeKey: false, confirmButtonColor: "#698F3F", customClass: {confirmButton: "success-button", title: "title"}}).then(() => {
                                        window.location.href = "{% url 'Contributor Service Home' %}";
                                    });
                                };
                            });

                        {% else %}
                            fetch("{% url 'Contributor Service Report Fetch' %}", {
                                method: "POST",

                                headers: {"Content-Type": "application/json", "X-CSRFToken": token},

                                body: json

                            }).then(() => {
                                const request = indexedDB.open("cotseye", 1);

                                request.onsuccess = (event) => {
                                    const cotseye = event.target.result;
                                    
                                    const transaction = cotseye.transaction("cotseye_schema", "readwrite");
                                    
                                    const cotseye_schema = transaction.objectStore("cotseye_schema");
                                    
                                    cotseye_schema.clear();

                                    const username = "{{request.user.username}}";

                                    Swal.fire({title: "Yay!", text: username + ", " + "your information input recorded offline was delivered to COTSEye.", background: "#FFFFFF", icon: "success", iconColor: "#698F3F", allowOutsideClick: false, allowEscapeKey: false, confirmButtonColor: "#698F3F", customClass: {confirmButton: "success-button", title: "title"}}).then(() => {
                                        window.location.href = "{% url 'Contributor Service Home' %}";
                                    });
                                };
                            });
                        {% endif %}
                    };
                };
            };
        };
    </script>
{% endblock content %}