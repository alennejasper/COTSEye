{% extends "contributor/service/index/index.html" %}
{% load static %}

{% block content %}
    <style>
        
    </style>

    <!-- Start choose and capture -->
    <div class = "fixed inset-0 z-[-10] h-screen w-full">
        <img src = "/statics/assets/bg-2.jpg" class = "h-full w-full object-cover top-[-5rem]" alt="">
    </div>

    <h1 style="font-size:20px;" class = "my-[2rem] text-center text-[1rem] text-black">CREATE REPORT</h1>

    <form action = "" class = "report-form bg-white p-2 rounded-lg" method = "POST" enctype = "multipart/form-data">
        {% csrf_token %}

        <div id="tab1" class="tabcontent">        
            <div class="tabcontent2">
                <div class="controls-wrapper">
                    <!-- Capture with Camera -->
                    <div class="control-section">
                        <i class="fa-solid fa-camera"></i>
                        <label for="post-photo2" class ="capture-photo">
                            Capture with camera
                        </label>
                        <input type="file" class="invisible-input post-photo2" id="post-photo2" name="post_photos_capture" accept="image/*" capture="environment" multiple>
                    </div>
            
                    <!-- Choose an Image -->
                    <div class="control-section">
                        <i class="fa-solid fa-image"></i>
                        <label for="post-photo" class = "browse-photo">
                            Choose an image
                        </label>
                        <input type="file" class="invisible-input post-photo" id="post-photo" name="post_photos_choose" accept="image/*" multiple>
                    </div>
                </div>
            </div>
            <!-- end choose and capture -->

            <!-- start photo w/ delete -->
            <div class="report-gallery"></div>
            <!-- end photo w/ delete -->
        
            <!-- start date -->
            <div class="date-picker-container">
                <label for="capture-date">Capture Date</label>
                <input type="date" id="capture-date" name="capture_date" required>
            </div>
            <!-- end date -->
            

            <!-- <div class = "report-gallery my-4">
                <img class = "gallery-photo" src = "{% static 'assets/posts/default.png' %}">
            </div> -->

            <h1 class = "my-[1rem] text-center  text-[1rem] text-[#003755]">LOCATION</h1>


            <div class = "map w-full">
                <div class=  "report-map w-full">
                </div>
            </div>

            <div class="coordinates-container">
                <div class="coordinate-input">
                    <!-- <label style="font-size: 10px;" for="latitude">Lat:</label> -->
                    <input type="hidden" id="latitude" name="latitude">
                </div>
                <div class="coordinate-input ">
                    <!-- <label style="font-size: 10px;" for="longitude">Long:</label> -->
                    <input type="hidden" id="longitude" name="longitude">
                </div>
            </div>

            <div class="location-input">
                <input style="font-size: 15px;" id="location" name="location">
            </div>


<!--             <div class = "flex w-full justify-end my-4">
                <div class = "border-2 w-fit h-[3rem] bg-green-500 text-white font-bold hover:bg-white hover:border-green-600 hover:text-green-600 text-center cursor-pointer p-2 rounded-lg">
                    <a class = "refresh-map" onclick = "refreshMap()">Refresh</a>
                </div>
            </div> -->



            <div class = "flex w-full justify-between items-center my-[1.5rem] h-[6rem] sticky bottom-0 left-0 bg-white z-50 border-">
                <div class = "border-2 w-[15rem] flex rounded-full justify-center bg-[#003755] text-white hover:bg-white hover:border-[#003755] hover:text-[#003755] text-center cursor-pointer p-2">
                    <a class = "uppercase">Save as draft</a>
                </div>

                <button type = "button" class = "border-2 w-[15rem] rounded-full bg-[#003755] text-white hover:bg-white hover:border-[#003755] hover:text-[#003755] text-center cursor-pointer p-2" onclick = "nextTab('tab1')">Next</button>
            </div>
        </div>

        <div id = "tab2" class = "tabcontent w-full" style = "display:none;">
            <h1 class = "my-[2rem] text-center font-semibold text-[2rem] text-[#003755]">OTHER DETAILS</h1>

            <div class="w-full flex flex-col">

                <label class = "font-semibold my-2" for = "description">DESCRIPTION</label>

                <textarea class = "border-2 p-2 h-[8rem] border-black" type = "text" id = "description" name = "description" required></textarea>
            </div>

            <h1 class = "my-[2rem] text-center font-semibold text-[2rem] text-[#003755]">OPTIONALS</h1>

            <div class = "flex flex-col gap-4">
                <div class = "w-full flex flex-col gap-2">
                    <label class = "font-semibold" for = "size">SIZE</label>
                    
                    <input placeholder = "Size of COTS (ex. 12-15 cm)" class = "h-[2.5rem] border-2 p-2 border-black" type = "number" value = "" id = "size" name = "size">
                </div>

                
                <div class = "w-full flex flex-col gap-2">
                    <label class = "font-semibold" for = "density">DENSITY</label>
                    
                    <input placeholder = "Estimated Number of COTS (ex. 15)" class = "h-[2.5rem] border-2 p-2 border-black" type = "number" value = "" id = "density" name = "density">
                </div>


                <div class = "w-full flex flex-col gap-2">
                    <label class = "font-semibold" for = "depth">DEPTH</label>
                    
                    <select class="h-[2.5rem] border-2 p-2 border-black" name = "depth" id = "depth">
                        <option disabled selected value>Depth</option>

                        {% for depth in depths %}
                            <option value="{{depth.id}}">{{depth}}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class = "w-full flex flex-col gap-2">
                    <label class = "font-semibold" for = "depth">WEATHER</label>
                    
                    <select class = "h-[2.5rem] border-2 p-2 border-black" name = "weather" id = "weather">
                        <option disabled selected value>Weather</option>

                        {% for weather in weathers %}
                            <option style = "width: 100vw;" value = "{{weather.id}}">{{weather}}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <input type="hidden" name="action" id="action">

            <div class = "flex w-full justify-between my-[1.5rem]">
                <div class = "tabs border-2 w-[15rem] rounded-full items-center flex justify-center h-[3rem] bg-[#003755] text-white font-semibold hover:bg-white hover:border-[#003755] hover:text-[#003755] text-center cursor-pointer p-2">
                    <button class = "tablink active flex gap-2 items-center text-lg text-center justify-center"
                        onclick = "openTab('tab1')">Back</button>
                </div>

                <div class="border-2 w-[15rem] rounded-full items-center flex justify-center h-[3rem] bg-[#003755] text-white font-semibold hover:bg-white hover:border-[#003755] hover:text-[#003755] text-center cursor-pointer p-2">
                    <a class="save-report uppercase" data-action = "save as draft">Save as draft</a>
                </div>
                
                <div class="border-2 w-[15rem] rounded-full items-center flex justify-center h-[3rem] bg-[#003755] text-white font-semibold hover:bg-white hover:border-[#003755] hover:text-[#003755] text-center cursor-pointer p-2">
                    <a class="save-report uppercase" data-action = "save and submit">Save and submit</a>
                </div>
            </div>
        </div>
    </form>

    <script>
        function openTab(tabName){
            var i, tabcontent, tablinks;

            tabcontent = document.getElementsByClassName("tabcontent");

            for (i = 0; i < tabcontent.length; i++){
                tabcontent[i].style.display = "none";
            }

            tablinks = document.getElementsByClassName("tablink");

            for (i = 0; i < tablinks.length; i++){
                tablinks[i].classList.remove("active");
            }

            document.getElementById(tabName).style.display = "block";

            event.currentTarget.classList.add("active");
        }

        function nextTab(currentTabId){
            var currentTab = document.getElementById(currentTabId);

            var nextTab = currentTab.nextElementSibling;

            openTab(nextTab.id);
        }

        openTab('tab1');
    </script>

<script>
    const browsePhoto = document.querySelector(".post-photo");
    const capturePhoto = document.querySelector(".post-photo2");
    const reportGallery = document.querySelector(".report-gallery");

    function addImageToGallery(file) {
        const reader = new FileReader();
        reader.onload = function(event) {
            const photoWrapper = document.createElement("div");
            photoWrapper.style.position = "relative";
            photoWrapper.style.display = "inline-block";
            photoWrapper.style.marginRight = "10px";

            const photoElement = document.createElement("img");
            photoElement.classList.add("gallery-photo");
            photoElement.src = event.target.result;
            photoElement.style.width = "100px";
            photoElement.style.height = "100px";

            const deleteButton = document.createElement("button");
            deleteButton.textContent = "X";
            deleteButton.classList.add("delete-btn");
            deleteButton.onclick = function() {
                reportGallery.removeChild(photoWrapper);
            };

            photoWrapper.appendChild(photoElement);
            photoWrapper.appendChild(deleteButton);
            reportGallery.appendChild(photoWrapper);
        };
        reader.readAsDataURL(file);
    }

    function handleFiles(files) {
        reportGallery.innerHTML = "";  // Clear existing images
        Array.from(files).forEach(file => addImageToGallery(file));
    }

    browsePhoto.addEventListener("change", (event) => {
        handleFiles(event.target.files);
    });

    capturePhoto.addEventListener("change", (event) => {
        handleFiles(event.target.files);
    });
</script>


    <script>
        document.querySelector(".browse-photo").addEventListener("click", function(){
            document.querySelector(".post-photo").click();
        });

    </script>

    <script>
        document.querySelector(".post-photo").addEventListener("change", function(){
            for (var i = 0; i < this.files.length; i++){
                var reportFile = this.files[i];

                var modifiedDate = reportFile.lastModifiedDate;

                var formattedDate = modifiedDate.toISOString().slice(0, 16);

                document.getElementById("capture-date").value = formattedDate;
            }
        });

        document.querySelector(".post-photo2").addEventListener("change", function(){
            for (var i = 0; i < this.files.length; i++){
                var reportFile = this.files[i];

                var modifiedDate = reportFile.lastModifiedDate;

                var formattedDate = modifiedDate.toISOString().slice(0, 16);

                document.getElementById("capture-date").value = formattedDate;
            }
        });
    </script>

    <script src = "https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <script src = "https://cdn.jsdelivr.net/npm/leaflet-geosearch/dist/geosearch.min.js"></script>

    <script src = "https://cdn.jsdelivr.net/npm/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

    <script src = "https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@v0.74.0/dist/L.Control.Locate.min.js" charset="utf-8"></script>

    <script>
        var map;

        var report;

        function revealMap(){
            var starfish = L.icon({iconUrl: "{% static 'assets/icons/marker.png' %}", iconSize: [30, 30], iconAnchor: [15, 15]});

            var report = L.marker([5.9656, 125.1929], {draggable: true, icon: starfish});

            var reportMap = document.getElementsByClassName("report-map")[0];
            
            var background = L.tileLayer("http://{s}.google.com/vt?lyrs=m&x={x}&y={y}&z={z}", {minZoom: 11, maxZoom: 15, subdomains:["mt0","mt1","mt2","mt3"], attribution: "Google"});

            map = L.map(reportMap, {zoomControl: true, scrollWheelZoom: false, dragging: true, maxBounds: [[5.3, 124.3],[6.3, 126.3]], layers: [background, report]}).setView([5.9656, 125.1929], 11);

            map.attributionControl.setPosition("bottomleft");
                
            report.on("drag", function(event){
                var position = event.target.getLatLng();
                
                updateCoordinates(position.lat, position.lng);
            });

            report.on("dragend", function(event){
                var position = event.target.getLatLng();
                
                updateCoordinates(position.lat, position.lng);
            });

            var defaultLatitude = report.getLatLng().lat;

            var defaultLongitude = report.getLatLng().lng;

            updateCoordinates(defaultLatitude, defaultLongitude);

            fetchLocation();
        
            L.control.locate().addTo(map);

            var geocoder = L.Control.geocoder({
                defaultMarkGeocode: false,
                
            }).on("markgeocode", function (e){
                var latlng = e.geocode.center;
                
                report.setLatLng(latlng);
                
                map.setView(latlng, 16);

                var popupContent = e.geocode.name;
    
                var popupInput = document.getElementById("location");

                popupInput.value = popupContent;
                
                report.bindPopup(popupContent).openPopup();

                var latitudeInput = document.getElementById("latitude");
                
                var longitudeInput = document.getElementById("longitude");
                
                latitudeInput.value = latlng.lat.toFixed(6);
                
                longitudeInput.value = latlng.lng.toFixed(6);

                map.panTo(latlng);
            }).addTo(map);

            var provider = new GeoSearch.OpenStreetMapProvider();

            var searchControl = new GeoSearch.GeoSearchControl({
                provider: provider,
            });

            searchControl.addTo(map);
        }

        function updateCoordinates(latitude, longitude){
            var latitudeInput = document.getElementById("latitude");

            var longitudeInput = document.getElementById("longitude");

            latitudeInput.value = latitude.toFixed(6);
            
            longitudeInput.value = longitude.toFixed(6);
        };

        window.addEventListener("load", function (){
            revealMap();
        });
    </script>

    <script>
        function refreshMap(){
            map.setView([5.9656, 125.1929], 11);
        };

        document.querySelector(".refresh-map").addEventListener("click", refreshMap);
    </script>

    <script>
        function fetchLocation(){
            if (navigator.geolocation){
                navigator.geolocation.getCurrentPosition(checkPosition);
                
            } else{
                Swal.fire({title: "Oops!", text: "The location is not supported and cannot be given to COTSEye.", background: "#FFFFFF", icon: "error", iconColor: "#C90016", allowOutsideClick: false, allowEscapeKey: false, confirmButtonColor: "#C90016", customClass: {confirmButton: "error-button", title: "title"}});                
            };
        };

        function checkPosition(position){
            const maximumLatitude = 6.3;

            const minimumLatitude = 5.3;
            
            const maximumLongitude = 126.3;
            
            const minimumLongitude = 124.3;
            
            const latitude = position.coords.latitude;
            
            const longitude = position.coords.longitude;

            if (latitude < minimumLatitude || latitude > maximumLatitude || longitude < minimumLongitude || longitude > maximumLongitude){
                
                document.querySelector(".post-photo2").addEventListener("click", function(){
                    event.preventDefault();
                    
                    /* Swal.fire({title: "Oops!", text: "The location given to COTSEye incorporated coordinates out of bounds.", background: "#FFFFFF", icon: "error", iconColor: "#C90016", allowOutsideClick: false, allowEscapeKey: false, confirmButtonColor: "#C90016", customClass: {confirmButton: "error-button", title: "title"}}); */
                });

            } else{
                updateCoordinates(latitude, longitude);

                report.setLatLng([latitude, longitude]);

                map.setView([latitude, longitude], 11);

                document.querySelector(".capture-photo").addEventListener("click", function(){
                    document.querySelector(".post-photo2").click();
                });

            }
        }

        document.addEventListener("DOMContentLoaded", function (){
            revealMap();

            const captureButton = document.querySelector(".post-photo2");

            if (captureButton){
                captureButton.addEventListener("click", function (event){
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
                        /* Swal.fire({title: "Oops!", text: "The camera is not supported and cannot be given to COTSEye.", background: "#FFFFFF", icon: "error", iconColor: "#C90016", allowOutsideClick: false, allowEscapeKey: false, confirmButtonColor: "#C90016", customClass: {confirmButton: "error-button", title: "title"}}); */
                    };
                });
            }
        });
    </script>

    <script>
        let reportPhoto;

        document.querySelector(".post-photo").addEventListener("change", function(e){
            const reportFile = e.target.files[0];

            const photo = new Image();

            photo.src = URL.createObjectURL(reportFile);

            photo.onload = function(){
                EXIF.getData(photo, function(){
                    const latitude = EXIF.getTag(this, "GPSLatitude");

                    const longitude = EXIF.getTag(this, "GPSLongitude");

                    if (latitude && longitude){
                        const roundLatitude = parseFloat(latitude).toFixed(6);

                        const roundLongitude = parseFloat(longitude).toFixed(6);
                        
                        if (checkCoordinates(roundLatitude, roundLongitude)){
                            document.getElementById("latitude").value = roundLatitude;

                            document.getElementById("longitude").value = roundLongitude;
                            
                            reportPhoto = photo;

                        } else{
                            Swal.fire({title: "Oops!", text: "The photo given to COTSEye incorporated coordinates out of bounds.", background: "#FFFFFF", icon: "error", iconColor: "#C90016", allowOutsideClick: false, allowEscapeKey: false, confirmButtonColor: "#C90016", customClass: {confirmButton: "error-button", title: "title"}});
                            
                            resetCaptureDate();

                            document.querySelector(".gallery-photo").src = "{% static 'assets/posts/default.png' %}";
                        };

                    } else{
                        Swal.fire({title: "Hey!", text: "The photo given to COTSEye did not incorporate any coordinates.", background: "#FFFFFF", icon: "warning", iconColor: "#154360", allowOutsideClick: false, allowEscapeKey: false, confirmButtonColor: "#154360", customClass: {confirmButton: "info-button", title: "title"}});
                    };
                });
            };
        });

        function checkCoordinates(latitude, longitude){
            const maximumLatitude = 6.3;

            const minimumLatitude = 5.3;
            
            const maximumLongitude = 126.3;
            
            const minimumLongitude = 124.3;

            return(
                latitude >= minimumLatitude &&
            
                latitude <= maximumLatitude &&
            
                longitude >= minimumLongitude &&
            
                longitude <= maximumLongitude
            );
        };

        function resetCaptureDate(){
            document.getElementById("capture-date").value = "";
        };
    </script>

    <script>
        document.querySelectorAll(".save-report").forEach(item => {
            item.addEventListener("click", function(event) {
                event.preventDefault();

                if (!navigator.onLine) {
                    const username = "{{ request.user.username }}";

                    Swal.fire({
                        title: "Hey!",
                        text: username + ", your information input was recorded offline for COTSEye. Kindly visit the current page again if back online.",
                        background: "#FFFFFF",
                        icon: "warning",
                        iconColor: "#154360",
                        allowOutsideClick: false,
                        allowEscapeKey: false,
                        confirmButtonColor: "#154360",
                        customClass: {
                            confirmButton: "info-button",
                            title: "title"
                        }
                    }).then(() => {
                        location.reload();
                    });

                } else {
                    const action = this.getAttribute("data-action");
                    document.getElementById("action").value = action;
                    document.querySelector(".report-form").submit();
                }
            });
        });
    </script>

    <script>
        const indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB || window.shimIndexedDB;
        
        const request = indexedDB.open("cotseye", 1);

        request.onupgradeneeded = (event) => {
            const cotseye = event.target.result;
        
            const cotseye_schema = cotseye.createObjectStore("cotseye_schema", {autoIncrement: true});
        };

        request.onsuccess = (event) => {
            const cotseye = event.target.result;

            const form = document.querySelector(".report-form");

            {% if draft_post %}
                const id = "{{draft_post.id}}";
            {% endif %}

            const user = "{{request.user.id}}";

            if(!navigator.onLine){
                document.querySelector(".post-photo").addEventListener("change", () => {
                    const files = document.querySelector(".post-photo").files;

                    for (let i = 0; i < files.length; i++){
                        const reader = new FileReader();
                        
                        reader.addEventListener("load", (event) => {
                            postPhotos.push(event.target.result);
                        });
                        
                        reader.readAsDataURL(files[i]);
                    };
                });

                const postPhotos = [];

                document.querySelector(".save-report").addEventListener("click", (event) => {
                    event.preventDefault();

                    const information = new FormData(form);

                    const captureDate = information.get("capture_date");

                    const description = information.get("description");

                    const latitude = information.get("latitude");

                    const longitude = information.get("longitude");

                    const size = information.get("size");

                    const depth = information.get("depth");

                    const density = information.get("density");

                    const weather = information.get("weather");

                    const transaction = cotseye.transaction("cotseye_schema", "readwrite");

                    const cotseye_schema = transaction.objectStore("cotseye_schema");

                    const post = {            
                        {% if draft_post %}
                            id: parseInt(id),
                        {% endif %}        

                        user: parseInt(user),

                        capture_date: new Date(captureDate),
                        
                        description: description,

                        post_photos: postPhotos,

                        latitude: parseFloat(latitude),

                        longitude: parseFloat(longitude),

                        size: parseInt(size),

                        depth: parseInt(depth),

                        density: parseInt(density),

                        weather: parseInt(weather)
                    };

                    cotseye_schema.add(post);
                }); 
            };

            if(navigator.onLine){
                const transaction = cotseye.transaction("cotseye_schema", "readonly");

                const cotseye_schema = transaction.objectStore("cotseye_schema");

                const post = cotseye_schema.getAll();

                post.onsuccess = (event) => {
                    const information = event.target.result;

                    if(information && information.length > 0){
                        const json = JSON.stringify(information);

                        const token = "{{csrf_token}}"

                        {% if draft_post %}
                            fetch("{% url 'Contributor Service Report Update Fetch' %}", {
                                method: "POST",

                                headers: {"Content-Type": "application/json", "X-CSRFToken": token},

                                body: json

                            }).then(() => {
                                const request = indexedDB.open("cotseye", 1);

                                request.onsuccess = (event) => {
                                    const cotseye = event.target.result;
                                    
                                    const transaction = cotseye.transaction("cotseye_schema", "readwrite");
                                    
                                    const cotseye_schema = transaction.objectStore("cotseye_schema");
                                    
                                    cotseye_schema.clear();

                                    const username = "{{request.user.username}}";

                                    Swal.fire({title: "Yay!", text: username + ", " + "your information input recorded offline was delivered to COTSEye.", background: "#FFFFFF", icon: "success", iconColor: "#698F3F", allowOutsideClick: false, allowEscapeKey: false, confirmButtonColor: "#698F3F", customClass: {confirmButton: "success-button", title: "title"}}).then(() => {
                                        window.location.href = "{% url 'Contributor Service Home' %}";
                                    });
                                };
                            });

                        {% else %}
                            fetch("{% url 'Contributor Service Report Fetch' %}", {
                                method: "POST",

                                headers: {"Content-Type": "application/json", "X-CSRFToken": token},

                                body: json

                            }).then(() => {
                                const request = indexedDB.open("cotseye", 1);

                                request.onsuccess = (event) => {
                                    const cotseye = event.target.result;
                                    
                                    const transaction = cotseye.transaction("cotseye_schema", "readwrite");
                                    
                                    const cotseye_schema = transaction.objectStore("cotseye_schema");
                                    
                                    cotseye_schema.clear();

                                    const username = "{{request.user.username}}";

                                    Swal.fire({title: "Yay!", text: username + ", " + "your information input recorded offline was delivered to COTSEye.", background: "#FFFFFF", icon: "success", iconColor: "#698F3F", allowOutsideClick: false, allowEscapeKey: false, confirmButtonColor: "#698F3F", customClass: {confirmButton: "success-button", title: "title"}}).then(() => {
                                        window.location.href = "{% url 'Contributor Service Home' %}";
                                    });
                                };
                            });
                        {% endif %}
                    };
                };
            };
        };
    </script>
{% endblock content %}