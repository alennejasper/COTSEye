{% extends "contributor/service/index/index.html" %}
{% load static %}

{% block content %}
    <div class = "home-body">
        <div class = "home-section">
            <h1>COTSEYE</h1>
            
            <p>Empowering coral reef preservation, one captured crown-of-thorns starfish at a time.</p>
        </div>

        <div class = "home-map">
            <div class = "map">
            </div>
        </div>

        <script>
            function revealMap(){    
                var map_statuses = L.layerGroup();
        
                function highlightBarangay(e){
                    var layer = e.target;
                    layer.setStyle({
                        color: "#10354C",
                        weight: 5,
                        fillOpacity: 0.75
                    });
                    layer.bringToFront();
                }
        
                // Function to reset barangay style
                function resetBarangay(e){
                    status.resetStyle(e.target);
                }
        
                // Function to zoom to a barangay
                function zoomBarangay(e){
                    var feature = e.target.feature;
                    var properties = feature.properties;
                    map.fitBounds(e.target.getBounds());
                    var center = e.target.getCenter();
                    var status = properties.statustype;
        
                    var fillings = {
                        "Critical": "#C90016",
                        "Moderate": "#F4C430",
                        "Low": "#698F3F",
                        "Default": "#003755"
                    }[status] || "#003755";
        
                    var popup = L.popup({closeOnClick: false, autoClose: false})
                        .setLatLng(center)
                        .setContent("<div class='popup'>" +
                            "<div class='popup-header'>" +
                            "<i class='fa-solid fa-circle-exclamation'></i>" +
                            "<i class='fa-solid fa-square-xmark popup-back'></i>" +
                            "</div>" +
                            "<div class='popup-place'>" +
                            "<p><a>" + properties.barangay + "</a>, " + properties.municipality + "</p>" +
                            "</div>" +
                            "<div class='popup-statistics'>" +
                            "<p>As of <a>" + properties.onset_date + "</a>:</p>" +
                            "<p><a style='color: " + fillings + ";'>" + properties.statustype + "</a> status,</p>" +
                            "<p><a>" + properties.caught_overall + "</a> COTS caught.</p>" +
                            "</div>" +
                            "</div>")
                        .openOn(map);
        
                    var popupBack = popup._contentNode.querySelector(".popup-back");
                    popupBack.addEventListener("click", function(){
                        map.closePopup(popup);
                    });
                }
        
                // Create the map
                var mapElement = document.getElementsByClassName("map")[0];
                var background = L.tileLayer("http://{s}.google.com/vt?lyrs=m&x={x}&y={y}&z={z}", {subdomains:["mt0", "mt1", "mt2", "mt3"]});
                var map = L.map(mapElement, {
                    zoomControl: true,
                    scrollWheelZoom: false,
                    dragging: true,
                    maxBounds: [[5.266008, 124.277344], [6.489983, 126.035156]],
                    layers: [background]
                }).setView([5.9656, 125.1929], 11);
        
                // Create markers for posts
                var map_posts = L.markerClusterGroup({removeOutsideVisibleBounds: false});
                {% for post in map_posts %}
                    var iconUrl = "{{post.post_photos.first.post_photo.url}}";
                    var starfishIcon = L.icon({
                        iconUrl: iconUrl,
                        iconSize: [30, 30],
                        iconAnchor: [15, 15],
                        className: "custom-leaflet-icon"
                    });
                    var postMarker = L.marker([{{post.coordinates.latitude}}, {{post.coordinates.longitude}}], {icon: starfishIcon});
        
                    postMarker.bindPopup("<div class='popup'>" +
                        "<div class='popup-header'>" +
                        "<img src='{{post.user.profile_photo.url | default:''}}'>" +
                        "<div class='popup-username'><p><a>{{post.user | default:'None available'}}</a></p></div>" +
                        "<i class='fa-solid fa-square-xmark popup-back'></i>" +
                        "</div>" +
                        "<div class='popup-post'>" +
                        "<div class='post-gallery'>" +
                        "<img src='{{post.post_photos.all.first.post_photo.url}}'>" +
                        "<div class='post-context'>" +
                        "<p>{{post.capture_date | default:'None available'}}</p>" +
                        "<a>{{post.location | default:'None available'}}</a>" +
                        "</div>" +
                        "</div>" +
                        "</div>" +
                        "<div class='button'><a class='read-post' href='{% url 'Post Valid Read Redirect' %}'>Read</a></div>", 
                        {closeOnClick: false, autoClose: false}
                    );
        
                    postMarker.on("popupopen", function(e){
                        var popup = e.popup;
                        var popupBack = popup.getElement().querySelector(".popup-back");
                        popupBack.onclick = function(){
                            popup.close();
                        };
                    });
        
                    postMarker.on("click", function(){
                        if (!this.isPopupOpen()){
                            this.openPopup();
                        }
                    });
        
                    map_posts.addLayer(postMarker);
                {% endfor %}
                map.addLayer(map_posts);
        
                map.on("popupopen", function(event){
                    var popup = map.project(event.target._popup._latlng);
                    popup.y -= event.target._popup._container.clientHeight / 2;
                    map.panTo(map.unproject(popup), {animate: true});
                });
        
                map.attributionControl.remove();
            }
        
            window.addEventListener("load", function (){
                revealMap();
            });
        </script>

        <div class = "home-cots">
            <img src = "{% static 'assets/cotpic1.jpeg' %}">
            
            <div class = "cots-context">
                <h1 class="COTS">CROWN-OF-THORNS STARFISH (COTS)</h1>

            </div>
        </div>

        <div class = "home-post">
            <h1>LATEST POSTS</h1>

            <div class = "post">
                {% for post in valid_posts %}
                    <div class = "post-gallery">
                        <a href="{% url 'Contributor Service Post Feed Read' post.id %}">
                            <img src = "{{post.post_photos.first.post_photo.url}}">
                        </a>
                
                        <div class = "post-context">
                            <p>{{post.location | default:'None available'}}</p>

                            <h1>{{post.user | default:'None available'}}</h1>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>

        <div class = "home-announcement">
            <h1>ANNOUNCEMENTS</h1>
            
            <div class = "announcement">
                {% for announcement in latest_announcements %}
                    <div class = "announcement-gallery">
                        <a href = "{% url 'Contributor Service Announcement Read' announcement.id %}">
                            <img src = "{{announcement.announcement_photo.url}}">
                        </a>

                        <!-- <div class = "announcement-context">
                            <h1>{{announcement.title | default:'None available'}}</h1>
                            
                            <p>{{announcement.context | default:'None available'}}</p>
                        </div> -->
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    {% if messages %}
        {% for message in messages %}
            {% if message.tags == "info" %}<script>Swal.fire({title: "Hey!", text: "{{message}}", background: "#FFFFFF", icon: "warning", iconColor: "#154360", allowOutsideClick: false, allowEscapeKey: false, confirmButtonColor: "#154360", customClass: {confirmButton: "info-button", title: "title"}})</script>
            {% elif message.tags == "success" %}<script>Swal.fire({title: "Yay!", text: "{{message}}", background: "#FFFFFF", icon: "success", iconColor: "#698F3F", allowOutsideClick: false, allowEscapeKey: false, confirmButtonColor: "#698F3F", customClass: {confirmButton: "success-button", title: "title"}})</script>
            {% else %}<script>Swal.fire({title: "Oops!", text: "{{message}}", background: "#FFFFFF", icon: "error", iconColor: "#C90016", allowOutsideClick: false, allowEscapeKey: false, confirmButtonColor: "#C90016", customClass: {confirmButton: "error-button", title: "title"}})</script>
            {% endif %}
        {% endfor %}
    {% endif %}

    <script type = "text/javascript">if (window.location.hash && window.location.hash === "#_=_"){window.location.hash = ""; history.pushState("", document.title, window.location.pathname);}</script>
{% endblock content %}