{% extends "officer/control/index/index.html" %}
{% load static %}
{% block content %}

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
<div class="container-fluid mt-3">
    <div class="row">
        <div class="col-12 col-md-3">
            <div class="filtercont">
                <p style="font-size: 17px !important; font-weight: 500; color: rgb(28, 179, 234);" class="fs-3 mb-3">FILTER</p>
                
                <select id="municipalityFilter" class="form-select form-select-sm mb-3 select2" onchange="updateBarangayOptions()">
                    <option value="">Municipality</option>
                    {% for location in locations %}
                        <option value="{{ location.municipality }}">{{ location.municipality }}</option>
                    {% endfor %}
                </select>
                <br>
                <br>
                <select id="barangayFilter" class="form-select form-select-sm mb-3 select2">
                    <option value="">Barangay</option>
                </select>

                <p style="font-size: 15px; color: rgb(28, 186, 234);" scope="col" class="mb-1">Date</p>
                
                <div class="mb-3">
                    <label for="dateFrom" class="form-label">From:</label>
                    <input type="date" id="dateFrom" name="dateFrom" class="form-control form-control-sm">
                </div>
                
                <div class="mb-3">
                    <label for="dateTo" class="form-label">To:</label>
                    <input type="date" id="dateTo" name="dateTo" class="form-control form-control-sm">
                </div>

                <p style="font-size: 15px; color: rgb(28, 172, 234);" scope="col" class="mb-1">Status</p>
                
                <div class="form-check mb-2">
                    <input class="form-check-input" type="radio" name="status" id="statusPending" value="Pending">
                    <label class="form-check-label" for="statusPending">Pending</label>
                </div>

                <div class="form-check mb-2">
                    <input class="form-check-input" type="radio" name="status" id="statusValid" value="Valid">
                    <label class="form-check-label" for="statusValid">Valid</label>
                </div>

                <div class="form-check mb-2">
                    <input class="form-check-input" type="radio" name="status" id="statusInvalid" value="Invalid">
                    <label class="form-check-label" for="statusInvalid">Invalid</label>
                </div>

                <button type="button" class="filterbutton" onclick="applyFilter()">Apply Filter</button>
                <button type="button" class="resetbutton" onclick="resetFilter()">Reset Filter</button>
            </div>
        </div>

        <div class="col-12 col-md-9">
            <div class="table-container mb-3">
                <h2 style="font-size: 19px; color: rgb(52, 144, 242); border-bottom: 1px solid rgba(229, 229, 229);">ALL SIGHTINGS</h2>

                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th style="font-size: 15px; color: rgb(28, 169, 234);" scope="col">Date Created</th>
                            <th style="font-size: 15px; color: rgb(28, 169, 234);" scope="col">Contributor</th>
                            <th style="font-size: 15px; color: rgb(28, 169, 234);" scope="col">Barangay</th>
                            <th style="font-size: 15px; color: rgb(28, 169, 234);" scope="col">Municipality</th>
                            <th style="font-size: 15px; color: rgb(28, 169, 234);" scope="col">Status</th>
                            <th style="font-size: 15px; color: rgb(28, 169, 234);" scope="col">Actions</th>
                        </tr>
                    </thead>

                    <tbody class="table-group-divider" id="sightingsTable">
                        {% for post in posts %}
                            <tr data-id="{{ post.id }}">
                                <td>{{ post.creation_date | date:'F j, Y, g:i a' }}</td>
                                <td>{{ post.user }}</td>
                                <td>{{ post.location.barangay }}</td>
                                <td>{{ post.location.municipality }}</td>
                                <td class="{% if post.post_status == 'Valid' %} valid-status {% elif post.post_status == 'Invalid' %} invalid-status {% elif post.post_status == 'Pending' %} pending-status {% endif %}">{{ post.post_status }}</td>
                                <td>
                                    <div class="button-container">
                                        <a onclick="shownDropdown()"><i class="fa-solid fa-arrow-down drop"></i></a>
                                        <a onclick="showPopup()"><i class="fa-solid fa-info-circle"></i></a>
                                        <div class="dropdown">
                                            <div class="dropdown-content">
                                                <a class="dropdown-header" value="Valid" onclick="changeStatus({{ post.id }}, 'Valid')">Valid</a>
                                                <a class="dropdown-footer" value="Invalid" onclick="changeStatus({{ post.id }}, 'Invalid')">Invalid</a>
                                            </div>
                                        </div>
                                        <button class="button-29" onclick="location.href='{% url 'Officer Control Sighting Read' post.id %}'">See more</button>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>

                <nav>
                    <ul class="pagination justify-content-center" id="pagination">
                        <li class="page-item" id="previousPage">
                            <a class="page-link" href="#" onclick="changePage('prev')">Previous</a>
                        </li>
                        <li class="page-item" id="nextPage">
                            <a class="page-link" href="#" onclick="changePage('next')">Next</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

<script>
    function shownDropdown(){
        event.stopPropagation();
        const dropdown = event.currentTarget.nextElementSibling.querySelector('.dropdown-content');
        dropdown.classList.toggle("show");
    };
    
    document.querySelectorAll('.info-icon').forEach(icon => {
        icon.addEventListener('click', function() {
            const postId = this.dataset.postId;
            showPopup(postId);
        });
    });

  

    function showPopup(postId) {
        fetch(`/officer/control/sighting/update/${postId}/`)
            .then(response => response.json())
            .then(data => {
                Swal.fire({
                    title: 'Popup Window',
                    html: `
                        <div class="map">
                            <div class="report-map" id="map" style="height: 300px;"></div>
                        </div>

                        <div class="coordinates">
                            <input type="hidden" id="latitude" name="latitude" value="${data.latitude}" required>
                            <input type="hidden" id="longitude" name="longitude" value="${data.longitude}" required>
                        </div>

                        <div class="municipality">
                            <label for="municipality">Municipality</label>
                            <select name="municipality" id="popupMunicipality" onchange="updateBarangayOptions()">
                                <option value="${data.location.municipality}" selected>${data.location.municipality}</option>
                                {% for location in locations %}
                                    {% if location.municipality != data.location.municipality %}
                                        <option value="{{location.municipality}}">{{location.municipality}}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>

                        <div class="barangay">
                            <label for="barangay">Barangay</label>
                            <select name="barangay" id="popupBarangay" onchange="updateMarker()">
                                <option value="${data.location.barangay}" selected>${data.location.barangay}</option>
                                {% for location in locations %}
                                    <option value="{{location.barangay}}">{{location.barangay}}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <button type="button" onclick="submitPopup(${postId})">Submit</button>
                    `,
                    didOpen: () => {
                        const latitude = parseFloat(document.getElementById('latitude').value);
                        const longitude = parseFloat(document.getElementById('longitude').value);
                        revealMap(latitude, longitude);
                    },
                    showConfirmButton: false
                });
            });
    }


    var map;
    var report;

    function revealMap(latitude, longitude) {
        var starfish = L.icon({iconUrl: "{% static 'assets/pin.png' %}", iconSize: [30, 30], iconAnchor: [15, 15]});
        report = L.marker([latitude, longitude], {draggable: true, icon: starfish});
        var reportMap = document.getElementsByClassName("report-map")[0];
        var background = L.tileLayer("http://{s}.google.com/vt?lyrs=m&x={x}&y={y}&z={z}", {minZoom: 11, maxZoom: 15, subdomains: ["mt0", "mt1", "mt2", "mt3"], attribution: "Google"});

        map = L.map(reportMap, {zoomControl: true, scrollWheelZoom: false, dragging: true, maxBounds: [[5.3, 124.3], [6.3, 126.3]], layers: [background, report]}).setView([latitude, longitude], 15);
        map.attributionControl.remove();

        {% for location in locations %}
            var originalCoordinates = {{location.perimeters|safe}};
            var swappedCoordinates = swapCoordinates(originalCoordinates);
            var polygon = L.polygon(swappedCoordinates, {color: "transparent", fillColor: "transparent", fillOpacity: 0}).addTo(map);
            polygon.locationId = {{location.id}};
            polygon.locationName = "{{location}}";
        {% endfor %}

        report.on("drag", function(event) {
            var position = event.target.getLatLng();
            updateCoordinates(position.lat, position.lng);
        });

        report.on("dragend", function(event) {
            var position = event.target.getLatLng();
            updateCoordinates(position.lat, position.lng);

            var selectElement = document.getElementById("barangay");
            selectElement.value = "";

            var selectElement2 = document.getElementById("municipality");
            selectElement2.value = "";

            map.eachLayer(function(layer) {
                if (layer instanceof L.Polygon) {
                    if (layer.getBounds().contains(position) && layer.locationId) {
                        selectElement.value = layer.locationId;
                        selectElement2.value = layer.locationId;
                        return;
                    }
                }
            });
        });

        updateBarangayOptions();
    }

    function updateCoordinates(latitude, longitude) {
        var latitudeInput = document.getElementById("latitude");
        var longitudeInput = document.getElementById("longitude");
        latitudeInput.value = latitude.toFixed(6);
        longitudeInput.value = longitude.toFixed(6);
    }

    function swapCoordinates(coordinates) {
        return coordinates.map(function(ring) {
            return ring.map(function(point) {
                return [point[1], point[0]];
            });
        });
    }

    function updateBarangayOptions() {
        const municipalityFilter = document.getElementById("popupMunicipality").value;
        const barangayFilter = document.getElementById("popupBarangay");

        if (municipalityFilter) {
            $.ajax({
                url: "{% url 'get_barangays' %}",
                data: {
                    "municipality": municipalityFilter
                },
                success: function(data) {
                    data.forEach(function(barangay) {
                        const option = document.createElement("option");
                        option.value = barangay;
                        option.textContent = barangay;
                        barangayFilter.appendChild(option);
                    });
                    $('#barangayFilter').select2();
                }
            });
        }
    }

    const barangayCoordinates = {
        {% for location in locations %}
            "{{location.barangay}}": [{{location.latitude}}, {{location.longitude}}],
        {% endfor %}
    };

    function updateMarker() {
        var barangayId = document.getElementById("popupBarangay").value;
        if (barangayCoordinates[barangayId]) {
            var coordinates = barangayCoordinates[barangayId];
            map.setView(coordinates, 15);
            report.setLatLng(coordinates);
            updateCoordinates(coordinates[0], coordinates[1]);
        }
    }

    function submitPopup(postId) {
    const municipality = document.getElementById('popupMunicipality').value;
    const barangay = document.getElementById('popupBarangay').value;
    const latitude = document.getElementById('latitude').value;
    const longitude = document.getElementById('longitude').value;

    const data = {
        municipality: municipality,
        barangay: barangay,
        latitude: parseFloat(latitude),
        longitude: parseFloat(longitude)
    };

    fetch(`/api/posts/update/${postId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{csrf_token}}' 
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.status === 'success') {
            Swal.fire({
                title: 'Submitted!',
                text: 'The form has been submitted.',
                icon: 'success',
                confirmButtonText: 'Close'
            });
        } else {
            Swal.fire({
                title: 'Error!',
                text: result.message,
                icon: 'error',
                confirmButtonText: 'Close'
            });
        }
    })
    .catch(error => {
        Swal.fire({
            title: 'Error!',
            text: 'An error occurred while submitting the form.',
            icon: 'error',
            confirmButtonText: 'Close'
        });
    });
}

    window.onclick = function(event) {
        if (!event.target.matches("i.drop")) {
            var dropdowns = document.getElementsByClassName("dropdown-content");
            for (var i = 0; i < dropdowns.length; i++) {
                var openDropdown = dropdowns[i];
                if (openDropdown.classList.contains("show")) {
                    openDropdown.classList.remove("show");
                }
            }
        }
    };

    $(document).ready(function() {
        $('.select2').select2();

        {% for post in posts %}
            if (['Valid', 'Invalid'].includes('{{ post.post_status }}')) {
                $('#status-select-{{ post.id }}').prop('disabled', true);
            }
        {% endfor %}
    });


    
        const sightingsData = [
            {% for post in posts %}
                {id: {{ post.id }}, date: "{{ post.creation_date | date:'F j, Y, g:i a' }}", user: "{{ post.user }}", barangay: "{{ post.location.barangay }}", municipality: "{{ post.location.municipality }}", status: "{{ post.post_status }}"},
            {% endfor %}
        ];

    let currentPage = 1;
    const rowsPerPage = 10;
    let filteredData = sightingsData;

    function displayTableData(page) {
        const tableBody = document.getElementById("sightingsTable");
        tableBody.innerHTML = "";

        const start = (page - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const pageData = filteredData.slice(start, end);

        pageData.forEach(item => {
            const statusClass = getStatusClass(item.status);
            const baseUrl = "{% url 'Officer Control Sighting Read' id=0 %}".replace("0", item.id);
            const disabled = (item.status === "Valid" || item.status === "Invalid") ? "disabled" : "";

            const row = `
                <tr data-id="${item.id}">
                    <td onclick="window.location.href='${baseUrl}'">${item.date}</td>
                    <td onclick="window.location.href='${baseUrl}'">${item.user}</td>
                    <td onclick="window.location.href='${baseUrl}'">${item.barangay}</td>
                    <td onclick="window.location.href='${baseUrl}'">${item.municipality}</td>
                    <td class="${statusClass}" onclick="window.location.href='${baseUrl}'">${item.status}</td>
                    <td>
                        <div class="button-container">
                            <a onclick="shownDropdown()"><i class="fa-solid fa-arrow-down drop"></i></a>
                            <a onclick="showPopup(${item.id})"><i class="fa-solid fa-info-circle"></i></a>
                            <div class="dropdown">
                                <div class="dropdown-content">
                                    <a class="dropdown-header" onclick="changeStatus(${item.id}, 'Valid')">Valid</a>
                                    <a class="dropdown-footer" onclick="changeStatus(${item.id}, 'Invalid')">Invalid</a>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>`;
            tableBody.innerHTML += row;
        });

        document.getElementById("previousPage").classList.toggle("disabled", page === 1);
        document.getElementById("nextPage").classList.toggle("disabled", end >= filteredData.length);
    }


    function changePage(direction) {
        if (direction === 'prev' && currentPage > 1) {
            currentPage--;
        } else if (direction === 'next' && (currentPage * rowsPerPage) < filteredData.length) {
            currentPage++;
        }
        displayTableData(currentPage);
        updatePagination();
    }

    function updatePagination() {
        const pagination = document.getElementById("pagination");
        const totalPages = Math.ceil(filteredData.length / rowsPerPage);
        pagination.innerHTML = `
            <li class="page-item" id="previousPage">
                <a class="page-link" href="#" onclick="changePage('prev')">Previous</a>
            </li>
            <li class="page-item" id="nextPage">
                <a class="page-link" href="#" onclick="changePage('next')">Next</a>
            </li>
        `;
        for (let i = 1; i <= totalPages; i++) {
            const pageItem = document.createElement("li");
            pageItem.className = "page-item" + (i === currentPage ? " active" : "");
            pageItem.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${i})">${i}</a>`;
            pagination.insertBefore(pageItem, document.getElementById('nextPage'));
        }
    }

    function goToPage(page) {
        currentPage = page;
        displayTableData(currentPage);
        updatePagination();
    }

    function parseDate(dateString) {
        try {
            const dateTimeRegex = /(\w+ \d+, \d+), (\d+:\d+ [ap]\.m\.)/;
            const match = dateTimeRegex.exec(dateString);
            if (!match) {
                throw new Error("Date format is invalid.");
            }
            const [_, datePart, timePart] = match;
            const [month, dayWithComma, year] = datePart.split(" ");
            const day = dayWithComma.replace(",", "");
            if (!month || !day || !year) {
                throw new Error("Date format is invalid.");
            }
            const [time, period] = timePart.split(" ");
            if (!time || !period) {
                throw new Error("Time format is invalid.");
            }
            let [hours, minutes] = time.split(":").map(Number);
            if (isNaN(hours) || isNaN(minutes)) {
                throw new Error("Time format is invalid.");
            }
            if (period.toLowerCase() === 'p.m.' && hours < 12) {
                hours += 12;
            } else if (period.toLowerCase() === 'a.m.' && hours === 12) {
                hours = 0;
            }
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            const monthIndex = monthNames.indexOf(month);
            if (monthIndex === -1) {
                throw new Error("Month format is invalid.");
            }
            return new Date(year, monthIndex, parseInt(day), hours, minutes);
        } catch (error) {
            console.error("Failed to parse date:", error);
            return null;
        }
    }

    function applyFilter() {
        const municipality = document.getElementById("municipalityFilter").value;
        const barangay = document.getElementById("barangayFilter").value;
        const dateFrom = document.getElementById("dateFrom").value;
        const dateTo = document.getElementById("dateTo").value;
        const status = document.querySelector("input[name='status']:checked")?.value;
        const dateFromObj = dateFrom ? new Date(dateFrom) : null;
        const dateToObj = dateTo ? new Date(dateTo) : null;
        filteredData = sightingsData.filter(item => {
            const itemDateObj = parseDate(item.date);
            const municipalityMatch = !municipality || item.municipality === municipality;
            const barangayMatch = !barangay || item.barangay === barangay;
            const dateFromMatch = !dateFrom || itemDateObj >= dateFromObj;
            const dateToMatch = !dateTo || itemDateObj <= dateToObj;
            const statusMatch = !status || item.status === status;
            return municipalityMatch && barangayMatch && dateFromMatch && dateToMatch && statusMatch;
        });
        currentPage = 1;
        displayTableData(currentPage);
        updatePagination();
    }

    function resetFilter() {
        document.getElementById("municipalityFilter").value = "";
        document.getElementById("barangayFilter").innerHTML = "<option value=''>Select Barangay</option>";
        document.getElementById("dateFrom").value = "";
        document.getElementById("dateTo").value = "";
        const checkedStatus = document.querySelector('input[name="status"]:checked');
        if (checkedStatus) {
            checkedStatus.checked = false;
        }
        filteredData = sightingsData;
        currentPage = 1;
        displayTableData(currentPage);
        updatePagination();
    }

    function changeStatus(postId, status) {
        if (!status) return;
        Swal.fire({
            title: 'Are you sure?',
            text: `You are about to change the status to "${status}".`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Yes, change it!',
            cancelButtonText: 'No, keep it'
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    type: 'POST',
                    url: status === 'Valid' ? '{% url "Officer Control Sighting Valid" %}' : '{% url "Officer Control Sighting Invalid" %}',
                    data: {
                        'post_id': postId,
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    success: function(response) {
                        if (response.success) {
                            location.reload();
                            Swal.fire(
                                'Changed!',
                                `The status has been changed to "${status}".`,
                                'success'
                            );
                        } else {
                            Swal.fire(
                                'Failed!',
                                'Failed to change the status.',
                                'error'
                            );
                        }
                    }
                });
            }
        });
    }

    function getStatusClass(status) {
        switch (status) {
            case 'Pending': return 'status-pending';
            case 'Valid': return 'status-valid';
            case 'Invalid': return 'status-invalid';
            default: return '';
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        displayTableData(currentPage);
        updatePagination();
    });
</script>

{% endblock %}
