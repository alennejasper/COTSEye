<!DOCTYPE html>
{% load static %}

<html lang = "en">
    <head>
        <meta charset = "UTF-8">

        <meta http-equiv = "X-UA-Compatible" content = "IE=edge">

        <meta name = "viewport" content = "width=device-width, initial-scale=1.0">
        
        <link rel = "stylesheet" type = "text/css" href = "{% static 'css/officer/control/index/index.css' %}">

        <link rel = "stylesheet" type = "text/css" href = "{% static 'css/officer/control/home/home.css' %}">
        
        <link rel = "stylesheet" type = "text/css" href = "{% static 'css/officer/control/sighting/sighting.css' %}">
         
        <link rel = "stylesheet" type = "text/css" href = "{% static 'css/officer/control/profile/profile.css' %}">
        
        <link rel = "stylesheet" type = "text/css" href = "{% static 'css/officer/control/profile/update.css' %}">

        <link rel = "stylesheet" type = "text/css" href = "{% static 'css/officer/control/announcement/announcement.css' %}">

        <link href = "https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel = "stylesheet">

        <script src = "https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

		<script src = "https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

		<script src = "https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>   

        <link rel = "stylesheet" href = "https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity = "sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin = "anonymous" referrerpolicy = "no-referrer"/>

        <script src = "https://code.jquery.com/jquery-3.6.0.min.js"></script>

        <link rel = "stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css">

        <script src = "https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
        
        <link rel = "stylesheet" href = "https://cdnjs.cloudflare.com/ajax/libs/daterangepicker/3.1/daterangepicker.css">

        <script src = "https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        
        <link rel = "stylesheet" href = "https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity = "sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin = ""/>    

        <script src = "https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity = "sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin = ""></script>
        
        <script src = "https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

        <script src = "https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.js"></script>

        <link rel = "stylesheet" href = "https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    
        <link rel = "stylesheet" href = "https://unpkg.com/leaflet-geosearch/dist/geosearch.css"/>
    
        <link rel = "stylesheet" href = "https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>
    
        <link rel = "stylesheet" href = "https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@v0.74.0/dist/L.Control.Locate.min.css"/>
        
		<script src = "https://cdn.jsdelivr.net/npm/chart.js"></script>

        <title>COTSEye | Home</title>
    </head>

    <body>
      <nav class = "navigation-topbar">
			<div class = "link">
				<a href = "{% url 'Officer Control Home' %}" class = "header"><img src = "{% static 'assets/icons/header.png' %}" class = "header"></a>
            
				<a href = "{% url 'Officer Control Sighting' %}">Sightings</a>

				<a href = "{% url 'Officer Control Status' %}">Infestations</a>

				<a href = "{% url 'Officer Control Intervention' %}">Activities</a>

				<a href = "{% url 'Officer Control Announcement' %}">Announcements</a>
			</div>

            <div class = "menu">
                <div class = "notification">
                    <a class = "notification-link">
                        <i class = "fa-solid fa-bell"></i>
    
                        {% if unread_notifications %}
                            <span class = "notification-count">{{unread_notifications | length}}</span>
                        {% endif %}
                    </a>
                </div>
                
                <a onclick = "shownProfile()" class = "profile"><img src = "{{user_profile.profile_photo.url}}" class = "drop profile"></a>
            </div>
        </nav>
        
        <div class = "menu-content">
            <div class = "notification-dropdown">
                <div id = "notification-content" class = "notification-content">
                    {% if unread_notifications %}
                        {% for post in unread_notifications %}
                                <a class = "dropdown-item" href = "{% url 'Officer Control Sighting Read' id=post.id %}" class = "post-link" post = "{{post.id}}">
                                    <div class = "item-header">
                                        <img src = "{{post.post_photos.first.post_photo.url}}">

                                        <div class = "item-context"> 
                                            <p><strong>{{post.user}}</strong> has sent a report.</p>

                                            <p>{{post.creation_date | date:'m/d/Y'}}</p>
                                        </div>
                                    </div>
                                </a>

                                <div class = "dropdown-divider"></div>
                        {% endfor %}
                    {% else %}

                        <a class = "dropdown-item">You have no unread notifications in the last 30 days.</a>
                    {% endif %}

                    <a href = "{% url 'Officer Control Notification' %}" class = "dropdown-footer">See More</a>
                </div>
            </div>

            <div class = "profile-dropdown">
                <div id = "profile-content" class = "profile-content">
                    <a class = "dropdown-header" href = "{% url 'Officer Control Profile' %}">{{username}}</a>

                    <div class = "dropdown-divider"></div>
                    
                    <a href = "{% url 'Officer Control Logout' %}" class = "dropdown-footer">Log out</a>
                </div>
            </div>
        </div>

		<div class = "content">
            {% block content %}
    
    
            {% endblock content %}
        </div>
	</body>

	<script>
        function shownProfile(){
            document.getElementById("profile-content").classList.toggle("show");
        };

        window.onclick = function(event){
            if (!event.target.matches("img.drop")){
                var dropdown = document.getElementsByClassName(".profile-content");

                var amount;

                for (amount = 0; amount < dropdown.length; amount++){
                    var openDropdown = dropdown[amount];
                    
                    if (openDropdown.classList.contains("show")){
                        openDropdown.classList.remove("show");
                    };
                };
            };
        };
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function (){
            const notification = document.querySelector(".notification-link");

            const dropdown = document.querySelector(".notification-content");

            notification.addEventListener("click", function (event){
                event.stopPropagation();
                
                dropdown.classList.toggle("show");
            });

            document.addEventListener("click", function (event){
                if (!dropdown.contains(event.target) && event.target !== notification){
                    dropdown.classList.remove("show");
                };
            });

            const postLink = document.querySelectorAll(".post-link");

            postLink.forEach(link => {
                link.addEventListener("click", function (event){
                    event.preventDefault();

                    const post = this.getAttribute("post");
                    
                    const url = "{% url 'mark_post_as_read' 0 %}".replace("0", post);

                    fetch(url, {
                        method: "GET",

                        headers: {
                            "X-Requested-With": "XMLHttpRequest",
                        },

                    }).then(response => response.json()).then(data => {
                        if (data.success){
                            this.parentElement.remove();

                            const notificationCount = document.querySelector("notification-count");

                            if (notificationCount) {
                                let count = parseInt(notificationCount.innerText);

                                count--;

                                if (count > 0){
                                    notificationCount.innerText = count;

                                } else{
                                    notificationCount.remove();
                                    const emptyMessage = document.createElement("a");

                                    emptyMessage.classList.add("dropdown-item");

                                    emptyMessage.innerText = "COTSEye found no unread posts in the last 30 days.";

                                    dropdown.appendChild(emptyMessage);
                                };
                            };

                            window.location.href = this.href;
                        };
                    });
                });
            });
        });
    </script>
    
    <script type = "text/javascript">if(window.location.hash && window.location.hash === "#_=_"){ window.location.hash = ""; history.pushState("", document.title, window.location.pathname);}</script>
</html>