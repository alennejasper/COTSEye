{% extends "officer/control/index/index.html" %}
{% load static %}

{% block content %}
<div class = "container-fluid mt-3">
    <div class = "d-flex justify-content-end">
        <button class = "btn btn-primary mt-4" style = "background-color: rgb(30, 173, 95);" onclick = "window.location.href = '{% url 'Officer Control Add Announcement' %}'">ADD NEW</button>
    </div>

    <div class="card mt-4">
        <div style = "text-align: center; font-weight: 500; font-size: larger;" class = "card-header bg-primary text-white">MANAGE ANNOUNCEMENTS</div>
        
        <div class = "card-body">
            <table class = "table table-bordered table-striped">
                <thead class = "thead-dark">
                    <tr>
                        <th>Title</th>

                        <th>Date</th>
                        
                        <th>Location</th>
                        
                        <th>Description</th>
                        
                        <th>Posted By</th>
                        
                        <th>Photo</th>
                        
                        <th>Actions</th>
                    </tr>
                </thead>

                <tbody id = "announcementsTable">
                </tbody>
            </table>
  
            <nav>
                <ul class = "pagination justify-content-center" id = "pagination">
                    <li class = "page-item" id = "previousPage">
                        <a class = "page-link" href = "#" onclick = "changePage('prev')">Previous</a>
                    </li>
                    
                    <li class = "page-item" id = "nextPage">
                        <a class = "page-link" href = "#" onclick = "changePage('next')">Next</a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function(){
        const announcements = [
            {% for announcement in announcements %}
                {id: {{announcement.id}}, title: "{{announcement.title}}", date: "{{announcement.release_date | date:'Y-m-d'}}", location: "{{announcement.place}}", description: "{{announcement.context}}", user: "{{announcement.user}}", photo: "{{announcement.announcement_photo.url}}"},
            {% endfor %}
        ];  
   
        let currentPage = 1;
        
        const itemsPerPage = 10;

        function displayAnnouncements(page){
            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedAnnouncements = announcements.slice(startIndex, endIndex);

            let table = document.getElementById('announcementsTable');
            table.innerHTML = '';

            paginatedAnnouncements.forEach((announcement, index) => {
                let row = table.insertRow();
                // Create link for the title
                let titleCell = row.insertCell(0);
                let titleLink = document.createElement('a');
                titleLink.href = "{% url 'Officer Control Announcement' pk=0 %}".replace('0', announcement.id);
                titleLink.innerText = announcement.title;
                titleCell.appendChild(titleLink);
                row.insertCell(1).innerText = announcement.date;
                row.insertCell(2).innerText = announcement.location;
                row.insertCell(3).innerText = announcement.description;
                row.insertCell(4).innerText = announcement.user;

                let photoCell = row.insertCell(5);
                    if (announcement.photo) {
                        let img = document.createElement('img');
                        img.src = announcement.photo;
                        img.style.width = '50px';
                        img.style.height = '50px';
                        photoCell.appendChild(img);
                    } else {
                        photoCell.innerText = 'No Photo';
                    }

                let actionsCell = row.insertCell(6);
                let updateButton = document.createElement('button');
                    updateButton.innerText = 'Update';
                    updateButton.classList.add('btn', 'btn-primary', 'btn-sm', 'mr-2');
                    updateButton.addEventListener('click', function() {
                        window.location.href = "{% url 'Officer Control Update Announcement' pk=0 %}".replace('0', announcement.id);

                });
                actionsCell.appendChild(updateButton);

                let deleteButton = document.createElement('button');
                    deleteButton.innerText = 'Delete';
                    deleteButton.classList.add('btn', 'btn-danger', 'btn-sm', 'ml-2');
                    deleteButton.addEventListener('click', function() {
                        fetch("{% url 'Officer Control Delete Announcement' pk=0 %}".replace('0', announcement.id), {
                            method: 'DELETE',
                            headers: {
                                'X-CSRFToken': '{{ csrf_token }}',
                                'Content-Type': 'application/json',
                            },
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                announcements.splice(startIndex + index, 1);
                                displayAnnouncements(currentPage);
                            } else {
                                alert('Failed to delete announcement.');
                            }
                        });
                    });
                actionsCell.appendChild(deleteButton);
            });

            const pagination = document.getElementById('pagination');
            const totalPages = Math.ceil(announcements.length / itemsPerPage);
            pagination.innerHTML = `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage('prev')">Previous</a>
                </li>
            `;

            for (let i = 1; i <= totalPages; i++) {
                pagination.innerHTML += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                    </li>
                `;
            }

            pagination.innerHTML += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage('next')">Next</a>
                </li>
            `;
        }

        window.changePage = function(action) {
            const totalPages = Math.ceil(announcements.length / itemsPerPage);

            if (action === 'prev' && currentPage > 1) {
                currentPage--;
            } else if (action === 'next' && currentPage < totalPages) {
                currentPage++;
            } else if (typeof action === 'number') {
                currentPage = action;
            }

            displayAnnouncements(currentPage);
        };

        displayAnnouncements(currentPage);
    });
</script>
{% endblock %}
